
    <form id="FormEditar" action="/recibo_inq_impreso" method="GET" class="row">
        <input
            type="hidden"
            id="numrecibo"
            name="numrecibo"
            value="<%= recibo.numrecibo %>"
        />
        <input type="hidden" name="letra" value="<%= letra %>" />

        <div class="receipt-container">
            <!-- <div class="paid-stamp">PAGADO</div> -->
            <div class="receipt-header">
                <h1>RECIBO DE COBRO</h1>
            </div>

            <div class="receipt-details">
                <div class="right">
                    <p>
                        <strong>Fecha:</strong>
                        <%= fechaActual %>
                    </p>
                </div>
            </div>
            <div class="receipt-details1">
                <div class="left">
                    <p>
                        <strong>Recibo N췈:</strong>
                        <span id="receiptNumber"> <%= recibo.numrecibo %> </span>
                    </p>
                </div>

                <div class="right">
                    <p>
                        <strong>Mes Cont:</strong>
                        <span id="ownerName"> <%= recibo.cuota %> </span>
                    </p>
                </div>
            </div>

            <div class="receipt-item">
                <p>
                    <strong>Recib칤 de:</strong>
                    <span id="apellidoinquilino"> <%= recibo.apellidoinquilino %> </span>
                    la suma de pesos <%= letra %>, ($ <%=
                    Number(recibo.total).toLocaleString("es-AR", {minimumFractionDigits:
                    2}) %> ) en concepto de pago de la locacion correspondiente a la
                    propiedad ubicada en la localidad de <%= propiedades.localidad %>, con
                    frente a la calle <%= propiedades.direccion %>, mes de <%=
                    mes_contrato %> con vencimiento el dia <%= vencimiento %> de <%=
                    mes_contrato %>.
                </p>
            </div>
            <div class="form-row">
                <label for="mensualidad" class="form-label">Mensualidad</label>
                <span>$</span>
                <input
                    type="text"
                    name="mensualidad"
                    value="<%= recibo.importemensual %>"
                />
            </div>
            <div class="form-row">
                <label for="abl" class="form-label">ABL</label>
                <span>$</span>
                <input type="text" name="abl" value="<%= recibo.abl %>" />
            </div>
            <div class="form-row">
                <label for="aysa" class="form-label">AYSA</label>
                <span>$</span>
                <input type="text" name="aysa" value="<%= recibo.aysa %>" />
            </div>
            <div class="form-row">
                <label for="exp_comunes" class="form-label">EXPENSAS COMUNES</label>
                <span>$</span>
                <input
                    type="text"
                    name="exp_comunes"
                    value="<%= recibo.expcomunes %>"
                />
            </div>
            <div class="form-row">
                <label for="seguro" class="form-label">SEGURO</label>
                <span>$</span>

                <input type="text" name="seguro" value="<%= recibo.seguro %>" />
            </div>
            <div class="form-row">
                <label for="varios" class="form-label">VARIOS</label>
                <span>$</span>
                <input type="text" name="varios" value="<%= recibo.varios %>" />
            </div>

            <div class="receipt-total">
                Total:
                <span
                    >$<span id="totalAmount">
                        <%= Number(recibo.total).toLocaleString("es-AR",
                        {minimumFractionDigits: 2}) %>
                    </span>
                </span>
            </div>

            <div class="receipt-signature">
                <div class="signature-line"></div>
                <p>Firma y Aclaraci칩n</p>
            </div>
        </div>

        <div class="button-container">
            <button type="button" id="btnImprimir" class="btn-imprimir">
                Imprimir Ahora
            </button>
            <button type="button" id="btnGuardar" class="btn-guardar">
                Guardar para Imprimir M치s Tarde
            </button>
            <button type="button" id="btnImprimirDia" class="btn-imprimir-dia">
                Imprimir Todos los Recibos del D칤a
            </button>
        </div>
    </form>
    <div
        id="messageBox"
        class="mt-4 p-3 rounded-md text-center hidden"
        role="alert"
    ></div>

    <script>
        // 游댢 Funci칩n para obtener los datos del recibo
        const getReceiptData = () => ({
            numrecibo: document.querySelector('[name="numrecibo"]').value,
            fechaActual: new Date().toLocaleDateString("es-AR"),
            apellidoinquilino: document
                .getElementById("apellidoinquilino")
                .textContent.trim(),
            total: parseFloat(
                document
                    .getElementById("totalAmount")
                    .textContent.replace(/\./g, "")
                    .replace(",", ".")
            ),
            importemensual: parseFloat(
                document.querySelector('[name="mensualidad"]').value
            ),
            letra: document.querySelector('[name="letra"]').value,

            abl: parseFloat(document.querySelector('[name="abl"]').value),
            aysa: parseFloat(document.querySelector('[name="aysa"]').value),
            expcomunes: parseFloat(
                document.querySelector('[name="exp_comunes"]').value
            ),
            seguro: parseFloat(document.querySelector('[name="seguro"]').value),
            varios: parseFloat(document.querySelector('[name="varios"]').value),
        });

        // 游빍 Validaci칩n de los datos recibidos
        const validateData = (data) => {
            return (
                data.numrecibo &&
                data.apellidoinquilino &&
                !isNaN(data.total) &&
                !Object.values(data).some((val) => val === undefined || val === null)
            );
        };

        // Funci칩n para mostrar mensajes en el cuadro de mensajes
        function showMessage(message, type = "info") {
            const messageBox = document.getElementById("messageBox");
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-md text-center ${
                type === "success" ? "bg-green-100 text-green-700" :
                type === "error" ? "bg-red-100 text-red-700" :
                "bg-blue-100 text-blue-700"
            }`;
            messageBox.style.display = "block";
            // Opcional: ocultar el mensaje despu칠s de un tiempo
            // setTimeout(() => { messageBox.style.display = "none"; }, 5000);
        }

        // 游빗 Asignaci칩n de eventos al cargar la p치gina
        document.addEventListener("DOMContentLoaded", () => {
            // Bot칩n "Imprimir Ahora" (descarga el recibo individual)
            document.getElementById("btnImprimir").addEventListener("click", function () {
                const numrecibo = document.querySelector('[name="numrecibo"]').value;
                if (numrecibo) {
                    // Abre la URL en una nueva pesta침a para forzar la descarga
                    window.open(`/generar_pdf/${numrecibo}`, '_blank');
                    showMessage("Descarga del recibo individual iniciada.", "info");
                } else {
                    showMessage("Error: No se encontr칩 el n칰mero de recibo para descargar.", "error");
                }
            });

            // Bot칩n "Guardar para Imprimir M치s Tarde"
            document.getElementById("btnGuardar").addEventListener("click", async function () {
                this.disabled = true;
                this.textContent = "Procesando...";
                try {
                    const data = getReceiptData();
                    if (!validateData(data)) {
                        throw new Error("Por favor complete todos los campos requeridos");
                    }

                    const response = await fetch("/save-receipt", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || "Error al procesar la solicitud");
                    }

                    showMessage("Recibo guardado exitosamente", "success");
                } catch (error) {
                    console.error("Error al guardar recibo:", error);
                    showMessage(error.message, "error");
                } finally {
                    this.disabled = false;
                    this.textContent = "Guardar para Imprimir M치s Tarde";
                }
            });

            // Bot칩n "Imprimir Todos los Recibos del D칤a" (descarga el PDF diario)
            document.getElementById("btnImprimirDia").addEventListener("click", async () => {
                const today = new Date().toISOString().split("T")[0];
                // Abre la URL en una nueva pesta침a para forzar la descarga del PDF diario
                window.open(`/generar_pdfs_dia?fecha=${today}`, '_blank');
                showMessage("Descarga de los recibos diarios iniciada.", "info");
            });
        });
    </script>

    <link rel="stylesheet" href="/css/recibo_imprimir.css" />
</body>
