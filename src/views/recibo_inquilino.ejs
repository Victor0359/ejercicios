<div class="container mt-5">



  <form action="/recibo_inquilino/insertar" method="POST">
    <h1 class="mb-5 "><b> RECIBO INQUILINO</b></h1>


    <% if (typeof mensaje !=="undefined" ) { %>
      <div class="alert alert-warning">
        <%= mensaje %>
      </div>
      <% } %>

        <div class="row mb-3 mt-5">
          <div class="col-md-4 mb-3">
            <label for="numero_recibo" class="form-label"><b>Numero recibo</b></label>
            <input type="text" class="auto-size form-control" id="numero_recibo" name="numrecibo"
              value="<%= numero_recibo %>" readonly />
          </div>
          <div class="col-md-4 mb-3">
            <label for="fecha_actual" class="form-label"><b>Fecha actual</b></label>
            <input type="text" class="auto-size form-control" id="fecha_actual" name="fecha_actual"
              value="<%= fecha_actual %>" readonly />
          </div>
          <div class="col-md-4 mb-3">
            <label for="id_propiedades" class="form-label "><b> Propiedad</b></label>
            <select class="form-select" id="id_propiedades" name="id_propiedad" required>
              <option value="">Seleccione una propiedad</option>
              <% if (propiedades && propiedades.length> 0) { %>
                <% propiedades.forEach(function(prop) { if (prop.direccion && prop.direccion.trim() !=="" ) { %>
                  <option value="<%= prop.id_propiedades %>">
                    <%= prop.direccion %>
                  </option>
                  <% } }); %>
                    <% } %>
            </select>
          </div>
        </div>

        <div class="row">

          <div class=" col-md-4 mb-3">
            <label for="apellidoinquilino" class="form-label"> <b> Inquilino</b></label>
            <input type="text" class="form-control auto-size" id="apellidoinquilino" name="apellidoinquilino"
              value="<%= apellidoinquilino %>" readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="apellidopropietario" class="form-label"> <b> Propietario</b></label>
            <input type="text" class=" form-control auto-size" id="apellidopropietario" name="apellidopropietario"
              value="<%= apellidopropietario %>" readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="cuota" class="form-label "><b>Cuota</b></label>
            <input type="number" id="cuota" class="form-control auto-size" name="cuota" value="<%= cuota %>" readonly>
          </div>


        </div>

        <div class="row">

          <div class="col-md-4 mb-3">
            <label for="importemensual" class="form-label"><b>Monto mensual</b></label>
            <input type="number" name="importemensual" id="importemensual" value="<%= importemensual %>">
          </div>

          <div class="col-md-4 mb-3">
            <label for="abl" class="form-label"><b>ABL</b></label>
           <input type="number" name="abl" id="abl" value="<%= abl %>">
          </div>
          <div class="col-md-4 mb-3">
            <label for="expcomunes" class="form-label"><b>Expensas comunes</b></label>
            <input type="number" name="expcomunes" id="expcomunes" value="<%= exp_comunes %>">
              
          </div>
        </div>
        <div class="row">

          <div class="col-md-4 mb-3">
            <label for="aysa" class="form-label"><b>AYSA</b></label>
           <input type="number" name="aysa" id="aysa" value="<%= aysa %>">
          </div>
          <div class="col-md-4 mb-3">
            <label for="seguro" class="form-label"><b>SEGURO</b></label>
            <input type="number" name="seguro" id="seguro" value="<%= seguro %>">
          </div>
          <div class="col-md-4 mb-3">
          <label for="varios">Varios</label>
          <input type="number" name="varios" id="varios" value="<%= varios || 0 %>">
          </div>
          <div class="col-md-4 mb-3">
            <label for="total" class="form-label "><b>TOTAL</b></label>
            <input type="number" name="total" id="total" readonly>
          </div>
        
        <div class=" mt-5 mr-2 no-print">
          <button type="submit" class="btn btn-primary" id="btn-generar-recibo">Generar Recibo</button>
          <a href="/recibo_inquilino" class="btn btn-secondary">Cancelar</a>


          <a href="/recibo_alquiler/buscar" class="btn btn-secondary mr-2">Buscar Recibo</a>

          
        </div>
  </form>

  <div class=" mt-3">
    <p>Nota: Este recibo es un comprobante de pago y debe ser guardado por el inquilino.</p>
  </div>

  <!-- <div class="no-print mt-3">
    <p>Para imprimir, haga clic en el botón "Imprimir" o use la función de impresión de su navegador.</p>
  </div> -->

</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 1) Referencia al <select>
  const sel = document.getElementById('id_propiedades');
  if (!sel) return;

  // 2) Función para parsear números
  const toNumber = v => parseFloat(v) || 0;

  // 3) Función que recalcula el total
  function recalcularTotal() {
    const m  = toNumber(document.getElementById('importemensual')?.value);
    const a  = toNumber(document.getElementById('abl')?.value);
    const ay = toNumber(document.getElementById('aysa')?.value);
    const e  = toNumber(document.getElementById('expcomunes')?.value);
    const s  = toNumber(document.getElementById('seguro')?.value);
    const v  = toNumber(document.getElementById('varios')?.value);
    document.getElementById('total').value = (m + a + ay + e + s + v).toFixed(2);
  }

  // 4) Función que pinta los datos JSON en los inputs
  function actualizarCampos(data) {
    // Mapeo manual de cada campo — el key debe coincidir exactamente con el JSON
    document.getElementById('numero_recibo').value     = data.numero_recibo     || '';
    document.getElementById('fecha_actual').value      = data.fecha_actual      || '';
    document.getElementById('apellidoinquilino').value = data.apellidoinquilino || '';
    document.getElementById('apellidopropietario').value = data.apellidopropietario || '';
    document.getElementById('cuota').value             = data.cuota             || '';
    document.getElementById('importemensual').value     = data.importemensual     || '';
    document.getElementById('expcomunes').value        = data.expcomunes        || '';
    document.getElementById('abl').value                = data.abl                || '';
    document.getElementById('aysa').value               = data.aysa               || '';
    document.getElementById('seguro').value             = data.seguro             || '';
    document.getElementById('varios').value             = data.varios             || '';
    document.getElementById('total').value              = data.total              || '';
    recalcularTotal();
  }

  // 5) Cuando cambie el select, hacemos fetch y pintamos
  sel.addEventListener('change', async () => {
    const id = sel.value;
    if (!id) return;
    const res  = await fetch(`/api/datos_propiedad?id_propiedades=${id}`);
    const data = await res.json();
    console.log('API ➞', data);   // <--- Asegurate de ver el JSON en consola
    actualizarCampos(data);
  });

  // 6) Enlazamos inputs para recalcular en tiempo real
  ['importemensual','abl','aysa','expcomunes','seguro','varios']
    .forEach(id => document.getElementById(id)
      ?.addEventListener('input', recalcularTotal)
    );

  // 7) Confirmación de envío
  const form = document.querySelector('form[action="/recibo_inquilino/insertar"]');
  const btn  = document.getElementById('btn-generar-recibo');
  btn?.addEventListener('click', e => {
    if (!confirm('¿Desea insertar el recibo?')) e.preventDefault();
  });

  // 8) Cálculo inicial
  recalcularTotal();
});
</script>

</script>

</body>

</html>