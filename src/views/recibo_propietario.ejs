

<div class="container mt-5">

  <div id="mensaje-alerta">
  </div>

  <form id="form-recibo" action="/recibo_propietario/insertar" method="POST">
    <h1 class="mb-5 "><b> RECIBO PROPIETARIO</b></h1>


    <% if (typeof mensaje !=="undefined" ) { %>
      <div class="alert alert-warning">
        <%= mensaje %>
      </div>
      <% } %>


        <div class="row mb-3 mt-5">
          <div class="col-md-4 mb-3">
            <label for="numero_recibo" class="form-label"><b>Numero recibo</b></label>
            <input type="text" class="auto-size form-control" id="numero_recibo" name="numrecibo"
              value="<%= numero_recibo %>" readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="fecha_actual" class="form-label"><b>Fecha actual</b></label>
            <input type="text" class="auto-size form-control" id="fecha_actual" name="fecha" value="<%= fecha_actual %>"
              readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="id_propiedades" class="form-label "><b> Propiedad</b></label>
            <select class="form-select" id="id_propiedades" name="id_propiedad" required>
              <option value="">Seleccione una propiedad</option>
              <% if (propiedades && propiedades.length> 0) { %>
                <% propiedades.forEach(function(prop) { if (prop.direccion && prop.direccion.trim() !=="" ) { %>
                  <option value="<%= prop.id_propiedades %>">
                    <%= prop.direccion %>
                  </option>
                  <% } }); %>
                    <% } %>
            </select>
          </div>
        </div>

        <div class=" row  mb-3">

          <div class=" col-md-4 mb-3">
            <label for="apellidopropietario" class="form-label"> <b> Propietario</b></label>
            <input type="text" class="form-control auto-size" id="apellidopropietario" name="apellidopropietario"
              value="<%= apellidopropietario %>" readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="cuota" class="form-label "><b>Cuota</b></label>
            <input type="number" id="cuota" class="form-control auto-size" name="cuota" value="<%= cuota %>" readonly>
          </div>

          <div class="col-md-4 mb-3">
            <label for="fecha_rec" class="form-label "><b>fecha recibo cobro</b></label>
            <input type="date" id="fecha_rec" class="form-control auto-size" name="fecha_rec"
              value="<%= fecha_rec %>" readonly>
          </div>

          <div class="row mt-5">
            <div class="col-md-4 mb-3">
              <label for="importemensual" class="form-label"><b>Monto mensual</b></label>
              <input type="number" name="importemensual" id="importemensual" value="<%= importemensual %>">
            </div>
            <div class="col-md-4 mb-3">
              <label for="exp_ext"><b>Expensas extraor</b></label>
              <input type="number" name="exp_extraor" id="exp_extraor" value="<%= exp_extraor %>">
            </div>

            <div class="col-md-4 mb-3">
              <label for="seguro" class="form-label"><b>Seguro</b></label>
              <input type="number" name="seguro" id="seguro" value="<%= seguro %>">
            </div>
          </div>
          <div class=" row mt-3">
            <div class="col-md-4 mb-3">
              <label for="varios"><b>Varios</b></label>
              <input type="number" name="varios" id="varios" value="<%= varios || 0 %>">
            </div>


            <div class="col-md-4 mb-3">
              <label for="honorario"><b>Honorarios</b></label>
              <input type="number" name="honorarios" id="honorarios" value="<%= honorarios %>">
            </div>


            <div class="col-md-4 mb-3">
              <label for="total" class="form-label "><b>TOTAL</b></label>
              <input type="number" name="total" id="total" readonly>
            </div>
          </div>
          <div class=" mt-5 mr-2 no-print">
            

            <button type="submit" class="btn btn-primary" id="btn-generar-recibo">Generar Recibo</button>

            <a href="/recibo_propietario" class="btn btn-secondary">Cancelar</a>

            <a href="/recibo_prop_impreso/<%= numero_recibo %>" class="btn btn-secondary">Imprimir</a>


            <a href="/buscar_recProp" class="btn btn-secondary mr-2">Buscar Recibo</a>


          </div>
  </form>

  <div class=" mt-3">
    <p>Nota: Este recibo es un comprobante de pago y debe ser guardado por el inquilino.</p>
  </div>
</div>
<!-- <div class="no-print mt-3">
    <p>Para imprimir, haga clic en el bot√≥n "Imprimir" o use la funci√≥n de impresi√≥n de su navegador.</p>
  </div> -->

</div>
<link rel="stylesheet" href="/css/propiedades.css">

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('id_propiedades');
  const btn = document.getElementById('btn-generar-recibo');
  const form = document.querySelector('form[action="/recibo_propietario/insertar"]');

  // ‚úÖ Parsear n√∫meros
  const toNumber = v => parseFloat(v) || 0;

  // üî¢ Recalcular TOTAL
  function recalcularTotal() {
    const m = toNumber(document.getElementById('importemensual')?.value);
    const e = toNumber(document.getElementById('exp_extraor')?.value);
    const s = toNumber(document.getElementById('seguro')?.value);
    const v = toNumber(document.getElementById('varios')?.value);
    const a = toNumber(document.getElementById('honorarios')?.value);
    document.getElementById('total').value = (m - e + s + v - a).toFixed(2);
  }

  // üñäÔ∏è Pintar campos desde API
  function actualizarCampos(data) {
    const campos = [
      'numero_recibo', 'fecha_actual', 'fecha_rec', 'apellidopropietario',
      'cuota', 'importemensual', 'exp_extraor', 'seguro',
      'varios', 'honorarios', 'total'
    ];

    campos.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = data[id] || '';
      else console.warn(`‚ö†Ô∏è Campo "${id}" no encontrado.`);
    });

    recalcularTotal();
  }

  // üîÑ Actualizar campos al cambiar propiedad
  sel?.addEventListener('change', async () => {
    const id = sel.value;
    if (!id) return;
    try {
      const res = await fetch(`/api/datos_propiedad/propietario?id_propiedades=${id}`);
      const data = await res.json();
      console.log('API ‚ûû', data);
      actualizarCampos(data);
    } catch (err) {
      console.error('Error al cargar datos de propiedad:', err);
      alert('Error al obtener los datos del propietario');
    }
  });

  // ‚ú® Inputs que modifican el total
  ['importemensual', 'exp_extraor', 'seguro', 'varios', 'honorarios'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', recalcularTotal);
  });

  // üßæ Enviar el recibo con confirmaci√≥n
  btn?.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!confirm('¬øDesea insertar el recibo?')) return;

    const datos = {
      fecha: document.getElementById('fecha_actual')?.value,
      id_propiedad: document.getElementById('id_propiedades')?.value,
      apellidopropietario: document.getElementById('apellidopropietario')?.value,
      apellidoinquilino: '', // si ten√©s el campo pod√©s agregarlo
      numrecibo: document.getElementById('numero_recibo')?.value,
      cuota: document.getElementById('cuota')?.value,
      importemensual: document.getElementById('importemensual')?.value,
      exp_extraor: document.getElementById('exp_extraor')?.value,
      seguro: document.getElementById('seguro')?.value,
      varios: document.getElementById('varios')?.value,
      honorarios: document.getElementById('honorarios')?.value,
      total: document.getElementById('total')?.value,
      fecha_rec: document.getElementById('fecha_rec')?.value
    };

    try {
      const res = await fetch("/recibo_propietario/insertar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      const data = await res.json();
      if (data.exito) {
        alert(data.mensaje);
        window.location.href = data.redireccion;
      } else {
        alert("‚ö†Ô∏è " + data.mensaje);
      }
    } catch (err) {
      console.error("Error en el insert:", err);
      alert("‚ùå Error al insertar el recibo");
    }
  });
});
</script>








</body>

</html>