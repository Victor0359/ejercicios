<body>

  <div class="container mt-5">
    <h1>CONTRATOS</h1>
    <form class="row g-3 mt-2" action="/contratos/insertar" method="POST">

      <div class="col-md-6 mb-3">

        <label for="id_propietarios" class="form-label">Propietario</label>
        <select class="form-select" id="id_propietarios" name="id_propietarios" required>
          <option value="">Seleccione un propietario</option>
          <% if (propietarios && propietarios.length> 0) { %>
            <% propietarios.forEach(function(prop) { %>
              <option value="<%= prop.id_propietarios %>">
                <%= prop.apellido %>, <%= prop.nombre %>
              </option>
              <% }); %>
                <% } %>
        </select>
      </div>
      <div class="col-md-6 mb-3">

        <label for="id_inquilinos" class="form-label">Inquilino</label>
        <select class="form-select" id="id_inquilinos" name="id_inquilinos" required>
          <option value="">Seleccione un inquilino</option>
          <% if (inquilinos && inquilinos.length> 0) { %>
            <% inquilinos.forEach(function(prop) { %>
              <option value="<%= prop.id_inquilinos %>">
                <%= prop.apellido %>, <%= prop.nombre %>
              </option>
              <% }); %>
                <% } %>
        </select>
      </div>

      <div class="col-md-6 mb-3">

        <label for="id_propiedades" class="form-label">Propiedad</label>
        <select class="form-select" id="id_propiedades" name="id_propiedades" required>
          <option value="">Seleccione una propiedad</option>
          <% if (propiedades && propiedades.length> 0) { %>
            <% propiedades.forEach(function(prop) { %>
              <% if (prop.direccion && prop.direccion.trim() !=="" ) { %>
                <option value="<%= prop.id_propiedades %>">
                  <%= prop.direccion %>
                </option>
                <% } %>
                  <% }); %>
                    <% } %>
        </select>

      </div>
      <div class="col-md-6 mb-3">
        <label for="fecha_inicio" class="form-label">Fecha inicio</label>
        <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" placeholder="Fecha inicio">
      </div>


      <div class="col-md-6 mb-3">
        <label for="precio_inicial" class="form-label">Precio_inicial</label>
        <input type="number" class="form-control" id="precio_inicial" name="precioinicial" placeholder="Precio_inicial">
      </div>
      <div class="col-md-6 mb-3">
        <label for="precio_actual" class="form-label">Precio actual</label>
        <input type="number" class="form-control" id="precio_actual" name="precioactual" placeholder="Precio actual">
      </div>
      <div class="col-md-6 mb-3">
        <label for="honorarios" class="form-label">Honorarios</label>
        <input type="number" class="form-control" id="honorarios" name="honorarios" placeholder="Honorarios">
      </div>
      <div class="col-md-6 mb-3">
        <label for="duracion_cont" class="form-label">Duracion contrato</label>
        <input type="number" class="form-control" id="duracion_cont" name="duracion_contrato"
          placeholder="Duracion contrato">
      </div>

      <div class="col-md-6 mb-3">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="/contratos" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>

  <div class="container mt-5">
    <div class="mt-5">
      <h1>Contratos</h1>
      <form method="GET" action="/contratos" class="row g-3" autocomplete="off">
        <div class="col-md-6">
          <label for="filtroPropiedad" class="form-label">Filtrar por Propiedad</label>
          <select class="form-select" id="filtroPropiedad" name="id_propiedad" onchange="this.form.submit()"
            autocomplete="off">

            <option value="" <%=!id_propiedad ? 'selected' : '' %>>Todas las propiedades</option>

            <% propiedades.forEach(function(prop) { %>
              <% if (prop.direccion && prop.direccion.trim() !=="" ) { %>
                <option value="<%= prop.id_propiedades %>" <%=String(prop.id_propiedades)===String(id_propiedad)
                  ? 'selected' : '' %>>
                  <%= prop.direccion %>
                </option>
                <% } %>
                  <% }); %>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <a href="/contratos" class="btn btn-secondary">Limpiar filtro</a>
        </div>
      </form>

      <div class="row mt-3">
        <div class="col">

          <table class="table table-striped table-bordered border-primary">

            <thead>
              <thead>
                <tr>
                  <th class="text-primary" scope="col">ID</th>
                  <th class="text-primary" scope="col">propietario</th>
                  <th class="text-primary" scope="col">inquilinos</th>
                  <th class="text-primary" scope="col">propiedades</th>
                  <th class="text-primary" scope="col">fecha</th>
                  <th class="text-primary" scope="col">precio inicial</th>
                  <th class="text-primary" scope="col">precio actual</th>
                  <th class="text-primary" scope="col">honorarios</th>
                  <th class="text-primary" scope="col">duracion</th>
                  <th class="text-primary" scope="col">fecha finalcontrato</th>
                  <th class="text-primary" scope="col">Editar</th>
                </tr>
              </thead>
            <tbody>

              <% if (hayFiltro && contratos.length===0) { %>
                <tr>
                  <td colspan="12" class="text-center text-muted">
                    No hay contratos registrados para esta propiedad.
                  </td>
                </tr>
                <% } else if (!hayFiltro) { %>
                  <tr>
                    <td colspan="12" class="text-center text-muted">
                      Seleccioná una propiedad para ver sus contratos.
                    </td>
                  </tr>
                  <% } else { %>
                    <% contratos.forEach(function(inquilino) { %>
                      <tr>
                        <td>
                          <%= inquilino.id_contratos %>
                        </td>
                        <td>
                          <%= inquilino.id_propietarios %>
                        </td>
                        <td>
                          <%= inquilino.id_inquilinos %>
                        </td>
                        <td>
                          <%= inquilino.id_propiedades %>
                        </td>
                        <td>
                          <%= inquilino.fecha_inicio ? new Date(inquilino.fecha_inicio).toLocaleDateString('es-AR') : ''
                            %>
                        </td>
                        <td>
                          <%= inquilino.precioinicial %>
                        </td>
                        <td>
                          <%= inquilino.precioactual %>
                        </td>
                        <td>
                          <%= inquilino.honorarios %>
                        </td>
                        <td>
                          <%= inquilino.duracion_contrato %>
                        </td>
                        <td>
                          <%= inquilino.fecha_finalcontrato ? new
                            Date(inquilino.fecha_finalcontrato).toLocaleDateString('es-AR') : '' %>
                        </td>
                        <td><a href="/contratos/editar/<%= inquilino.id_contratos %>"
                            class="btn btn-warning">Editar</a></td>
                      </tr>
                      <% }); %>

                        <% } %>

            </tbody>
          </table>
        </div>
      </div>
      <script>
        function confirmaIngresar() {
          return confirm("¿Está seguro que desea insertar este  registro");
        }
      </script>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const selector = document.getElementById("filtroPropiedad");
          if (selector) {
            selector.addEventListener("change", function () {
              this.form.submit();
            });
          }
        });
      </script>


</body>

</html>